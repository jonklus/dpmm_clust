---
title: "Model Spec Comparison"
author: "Jonathan Klus"
date: "2024-07-12"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

# homemade functions
source("./Multivariate_DPMM_unknownvar_DEV.R")
# source("./Multivariate_DPMM_unknownvar_DEE.R")
#source("./Multivariate_DPMM_unknownvar_UVV.R")
source("./posterior_helper_fxns.R")
source("./post_processing_inf.R")

# load R libraries
library(ggplot2)
library(dplyr)
library(stringr)
library(knitr) # kable
library(kableExtra) # use for complex tables http://haozhu233.github.io/kableExtra/awesome_table_in_pdf.pdf 
library(scatterplot3d)

######################## DEFINE HELPER FUNCTIONS################################
# running locally
# data_path = "//GENE.bst.rochester.edu/Projects/JKSTproj/BlueHive_Sim_Results/"

# running on server
data_path = "/projects/jklus/JKSTproj/BlueHive_Sim_Results/SummaryProposal"

# dev_withSM = readRDS(paste0(data_path, "/MODSUM_conjDEV_3close_n30_withSM_sim_results_ENAR/sum_1.rds"))

# list file extensions
file_ext = list.dirs(data_path)

# for each extension, make a new element of a data table with simulation attributes
summary_table = data.frame(Model = NA, Scenario = NA, SM = NA, Tag = NA, n_obs = NA, dataset_no = NA,
                           ARI = NA, KL = NA, Time = NA) # should add , SumTime = NA for mod summary compute time

for(ext_index in 2:length(file_ext)){ # skip first one, listing main directory
                                      # skip second one, Archive directory
  # list files
  file_list = list.files(path = file_ext[ext_index])
  if(length(file_list) > 0){
    
    temp_summary_table = data.frame(Model = NA, Scenario = NA, SM = NA, Tag = NA, n_obs = NA, dataset_no = NA,
                                    ARI = NA, KL = NA, Time = NA) # should add , SumTime = NA for mod summary compute time
    # parse out attributes and save
    short_file_ext = stringr::str_split(string = file_ext[ext_index], pattern = "/MODSUM")[[1]][2]
    parsed_dirname = unlist(stringr::str_extract_all(string = file_ext[ext_index], pattern = "_[:alnum:]+"))
    temp_summary_table[1:length(file_list), "Model"] = stringr::str_remove(string = parsed_dirname[3], pattern = "_")
    temp_summary_table[1:length(file_list), "Scenario"] = stringr::str_remove(string = parsed_dirname[4], pattern = "_")
    temp_summary_table[1:length(file_list), "n_obs"] = stringr::str_remove(string = parsed_dirname[5], pattern = "_n")
    temp_summary_table[1:length(file_list), "SM"] = stringr::str_remove(string = parsed_dirname[6], pattern = "_")
    # temp_summary_table[1:length(file_list), "Tag"] = stringr::str_remove(string = parsed_dirname[length(parsed_dirname)], pattern = "_")
    temp_summary_table[, "dataset_no"] = as.numeric(stringr::str_remove_all(string = file_list, pattern = "sum_|.rds"))
    
    # loop through all files in directory
    sum_bydataset = t(sapply(X = 1:length(file_list), 
                             FUN = function(x){
                               mod_sum = readRDS(paste0(file_ext[ext_index], "/", file_list[x]))
                               c(mod_sum$mean_ARI, mod_sum$kl_div, as.numeric(mod_sum$fit_runtime))
                             }))
    temp_summary_table[, "ARI"] = sum_bydataset[,1]
    temp_summary_table[, "KL"] = sum_bydataset[,2]
    temp_summary_table[, "Time"] = sum_bydataset[,3]
    summary_table = rbind(summary_table, temp_summary_table)
    
  }
  
}

summary_table = summary_table[-1,] # get rid of first row of NAs 
  #vdplyr::filter(Scenario == "5grp3d")
```

We fit the DEE and DEV models to a new scenario, with three dimensions and five 
latent groups. The data are generated from a mixture of 5 multivariate normal densities all with diagonal variance structure
and $\sigma^2 = 0.25. The true means are $(4, 4, -2)$, $(2, 3, 2)$, $(3, 2, 5)$, $(8, 8, 0)$, and $(9, 7, 3)$.

We also fit the original two scenarios (close together and well separated).

## Priors

### For close together scenarios

#### IG prior (DEV, DEE)

- Conjugate: $\sigma^2 \sim IG(a=1,b=25)$, and $s \sim Ga(f=1,g=50)$

#### InvW prior (UVV)

- Conjugate: $\Lambda_0 = diag(1)$ and $s \sim Ga(f=1,g=50)$

### For well separated scenarios

#### IG prior (DEV, DEE)

- Conjugate: $\sigma^2 \sim IG(a=1,b=50)$ and $s \sim Ga(f=1,g=50)$
- Non-Conjugate: $\sigma^2 \sim IG(a=1,b=50)$, and $\mu_k \sim N(\mu_0, \sigma^2_0 = 200)$

#### InvW prior (UVV)

- Conjugate: $\Lambda_0 = diag(1)$ and $s \sim Ga(f=1,g=50)$
- Non-Conjugate: $\Lambda_0 = diag(25)$ and $\mu_k \sim N(\mu_0, \Sigma_0 = diag(200))$

### For 3D 5 group scenarios

#### IG prior (DEV, DEE)

- Conjugate: $\sigma^2 \sim IG(a=1,b=1)$ and $s \sim Ga(f=1,g=10)$
- Non-Conjugate: $\sigma^2 \sim IG(a=1,b=1)$, and $\mu_k \sim N(\mu_0, \sigma^2_0 = 100)$

#### InvW prior (UVV)

- Conjugate: $\Lambda_0 = diag(1)$ and $s \sim Ga(f=1,g=10)$
- Non-Conjugate: $\Lambda_0 = diag(1)$ and $\mu_k \sim N(\mu_0, \Sigma_0 = diag(100))$

## Summary of Results

```{r, message=FALSE}

summary_table %>%
  # dplyr::filter(Tag == "ENAR") %>%
  dplyr::group_by(Model, Scenario, SM, n_obs) %>%
  dplyr::summarize(Count = n()) %>%
  tidyr::pivot_wider(names_from = c(n_obs, Scenario), values_from = Count) %>%
  # keep first 2 columns with model info, sort remaining cols with results by n
  dplyr::select(1,2, gtools::mixedorder(names(.)[3:length(names(.))])+2) %>%
  knitr::kable(caption = "Number of data sets completed")

# time
summary_table %>% 
  # dplyr::filter(Tag == "ENAR") %>%
  dplyr::group_by(Model, Scenario, SM, n_obs) %>%
  dplyr::summarize(Time = round(mean(Time),2)) %>%
  tidyr::pivot_wider(names_from = c(n_obs, Scenario), values_from = Time) %>%
  # keep first 2 columns with model info, sort remaining cols with results by n
  dplyr::select(1,2, gtools::mixedorder(names(.)[3:length(names(.))])+2) %>%
  knitr::kable(caption = "Average computation time")

summary_table %>% 
  # dplyr::filter(Tag == "ENAR") %>%
  dplyr::group_by(Model, Scenario, SM, n_obs) %>%
  dplyr::summarize(mean_ARI = round(mean(ARI),2)) %>%
  tidyr::pivot_wider(names_from = c(n_obs, Scenario), values_from = mean_ARI) %>%
  # keep first 2 columns with model info, sort remaining cols with results by n
  dplyr::select(1,2, gtools::mixedorder(names(.)[3:length(names(.))])+2) %>%
  knitr::kable(caption = "Adjusted RAND Index")

summary_table %>% 
  # dplyr::filter(Tag == "ENAR") %>%
  dplyr::group_by(Model, Scenario, SM, n_obs) %>%
  dplyr::summarize(KL = round(mean(KL),2)) %>%
  tidyr::pivot_wider(names_from = c(n_obs, Scenario), values_from = KL) %>%
  # keep first 2 columns with model info, sort remaining cols with results by n
  dplyr::select(1,2, gtools::mixedorder(names(.)[3:length(names(.))])+2) %>%
  knitr::kable(caption = "KL Divergence")
```



```{r, include=FALSE, eval=FALSE}

## Example of clustering
# resultex = readRDS(paste0(data_path, "/MODSUM_conjDEV_5grp3d_n100_noSM_sim_results_2024_06_27/sum_1.rds"))
seeds = readRDS("./BHsimseeds.rds") 
set.seed(seeds[1])
w = rep(0.2, 5)
means = list(
  c(4, 4, -2),
  c(2, 3, 2),
  c(3, 2, 5),
  c(8, 8, 0),
  c(9, 7, 3)
)
var = diag(0.25, length(means[[1]]))
assign = sample(x = 1:length(means), size = 100, replace = TRUE, prob = w)
y = lapply(X = assign,
           FUN = function(x){
             t(mvtnorm::rmvnorm(n = 1, mean = means[[x]], sigma = var))
           })
y_matrix = matrix(data = unlist(y), ncol = 3, byrow = TRUE)
data = data.frame(
  assign = assign,
  y1 = y_matrix[,1],
  y2 = y_matrix[,2],
  y3 = y_matrix[,3]
)
attach(data)

sim_results_DEV = MVN_CRP_sampler_DEV(
        S = 5000, seed = seeds[1], y = y,
        alpha = 1, r = 10, d = 1, f = 1 , g = 1, h = 10,
        sigma_hyperprior = FALSE, fix_r = FALSE,
        mu0 = matrix(round((colMeans(matrix(unlist(y), ncol = 3))),0), ncol = 1),
        a = 1, b = 1,
        k_init = 1, diag_weights = FALSE,
        verbose = TRUE, split_merge = FALSE #, sm_iter = 5
        )

scatterplot3d(x = y1, y = y2, z = y3, 
              color = sim_results_DEV$group_assign[1000,], 
              angle = -45)

scatterplot3d(x = y1, y = y2, z = y3, 
              color = sim_results_DEV$group_assign[2000,], 
              angle = -45)

scatterplot3d(x = y1, y = y2, z = y3, 
              color = sim_results_DEV$group_assign[3000,], 
              angle = -45)

scatterplot3d(x = y1, y = y2, z = y3, 
              color = sim_results_DEV$group_assign[4000,], 
              angle = -45)

scatterplot3d(x = y1, y = y2, z = y3, 
              color = sim_results_DEV$group_assign[5000,], 
              angle = -45)
```

