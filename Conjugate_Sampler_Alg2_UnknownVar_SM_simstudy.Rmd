---
title: "Conjugate Sampler - Split/Merge Demo"
author: "Jonathan Klus"
date: "2023-12-7"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# load necessary functions
source("./Multivariate_DPMM_unknownvar_DEV.R")
source("./Multivariate_DPMM_unknownvar_DEE.R")
source("./Multivariate_DPMM_unknownvar_UVV.R")
source("./posterior_helper_fxns.R")

# load R libraries
library(ggplot2)
library(gridExtra)
library(plotly)
library(label.switching)
library(LaplacesDemon)
library(parallel)
library(coda)
library(tidyr)
```

## DEE Sampler Setup

- $y_1, \dots, y_n \sim \sum_{k=1}^K\pi_kN(\mu_k, \sigma^2 I_J)$
- $\mu_1, \dots, \mu_K \sim N(\mu_0, r\sigma^2 I_J)$
- $\sigma^2 \sim IG(a,b)$
- $r \sim IG(g, h)$
- $b \sim Ga(d, f)$

## DEV Sampler Setup

- $y_1, \dots, y_n \sim \sum_{k=1}^K\pi_kN(\mu_k, \sigma^2_k I_J)$
- $\mu_1, \dots, \mu_K \sim N(\mu_0, r\sigma^2_k I_J)$
- $\sigma^2_1,\dots, \sigma^2_K \sim IG(a,b)$
- $r \sim IG(g, h)$
- $b \sim Ga(d, f)$

## Sampler Examples

### 2D Example - well separated

Mixture of 3 multivariate normal densities all with diagonal variance structure
and $\sigma^2 = 10$. The true means are $(-20,20)$, $(20,-20)$, and $(0,0)$, and
$\sum_{j}n_j = 30$.

```{r, echo=FALSE}
################## simulate data ##############################################

set.seed(516)
nreps = 10
seeds = sample(x = 1:10^4, size = nreps, replace = FALSE)

w = c(0.4, 0.3, 0.3)
means = list(
  c(-20, 20),
  c(20, -20),
  c(0, 0)
)

var = diag(10, length(means[[1]])) # variances known, diagonal, and equal

yreps = lapply(X = 1:nreps, 
           FUN = function(x){
             set.seed(seeds[x])
             assign = sample(x = 1:length(means), size = 30, replace = TRUE, prob = w)
             y = lapply(X = assign,
                        FUN = function(x){
                        t(mvtnorm::rmvnorm(n = 1, mean = means[[x]], sigma = var))
                          })
             return(list(y = y, assign = assign))
           })

# make a grid of plots
pltlist = list()
for(rep in 1:nreps){

  y_matrix = matrix(data = unlist(yreps[[rep]]$y), ncol = 2, byrow = TRUE)
  assign = yreps[[rep]]$assign

  data = data.frame(
    assign = assign,
    y1 = y_matrix[,1],
    y2 = y_matrix[,2]
  )

  p = ggplot(data = data, aes(x = y1, y = y2)) + #, label = rownames(data))) +
    geom_point(color = assign, size = 0.75) +
    #geom_text(size = 3, hjust = 0, nudge_x = 0.5, color = assign) +
    # geom_text(size = 3, color = assign) +
    theme_classic()

  pltlist[[rep]] = p
}

do.call(grid.arrange, pltlist)#, top = "Simulated 2D Data and True Group Assignments")

# drop params used to generate data, except for var which is assumed known
rm(w, means)
```

#### DEV sampler 

##### without split-merge step

```{r}
n_iter = 5000
use_cores = min(parallel::detectCores(), nreps)
# sim_results_DEV_no_sm = parallel::mclapply(X = 1:10, mc.cores = use_cores,
#       FUN = function(x){MVN_CRP_sampler_DEV(
#         S = n_iter, seed = seeds[x], y = yreps[[x]]$y, 
#         alpha = 1, r = 10, g = 1, h = 50,
#         sigma_hyperprior = FALSE, fix_r = FALSE, 
#         mu0 = matrix(round((colMeans(matrix(unlist(yreps[[x]]$y), ncol = 2))),0), ncol = 1), 
#         a = 1, b = 50,
#         k_init = 1, diag_weights = FALSE, 
#         verbose = FALSE, split_merge = FALSE
#         )}
#       )
# 
# saveRDS(object = sim_results_DEV_no_sm, file = "../MCMC_Runs/conjDEVsamp_minisimstudy_noSM_6_Dec_2023.rds")
sim_results_DEV_no_sm = readRDS(file = "../MCMC_Runs/conjDEVsamp_minisimstudy_noSM_6_Dec_2023.rds")

for(rep in 1:nreps){
  print(table(sim_results_DEV_no_sm[[rep]]$k))
  p1 = make_k_traceplot(k = sim_results_DEV_no_sm[[rep]]$k, 
                        group_assign = sim_results_DEV_no_sm[[rep]]$group_assign)
  print(p1)
}
```


##### with split-merge step

```{r}
# sim_results_DEV_with_sm = parallel::mclapply(X = 1:10, mc.cores = use_cores,
#       FUN = function(x){MVN_CRP_sampler_DEV(
#         S = n_iter, seed = seeds[x], y = yreps[[x]]$y, 
#         alpha = 1, r = 10, g = 1, h = 50,
#         sigma_hyperprior = FALSE, fix_r = FALSE, 
#         mu0 = matrix(round((colMeans(matrix(unlist(yreps[[x]]$y), ncol = 2))),0), ncol = 1), 
#         a = 1, b = 50,
#         k_init = 1, diag_weights = FALSE, 
#         verbose = FALSE, split_merge = TRUE, sm_iter = 10
#         )}
#       )
# 
# saveRDS(object = sim_results_DEV_with_sm, file = "../MCMC_Runs/conjDEVsamp_minisimstudy_withSM_6_Dec_2023.rds")
sim_results_DEV_with_sm = readRDS(file = "../MCMC_Runs/conjDEVsamp_minisimstudy_withSM_6_Dec_2023.rds")

for(rep in 1:nreps){
  print(table(sim_results_DEV_with_sm[[rep]]$k))
  p1 = make_k_traceplot(k = sim_results_DEV_with_sm[[rep]]$k, 
                        group_assign = sim_results_DEV_with_sm[[rep]]$group_assign)
  print(p1)
}
```

#### DEE sampler 

##### without split-merge step

```{r}
# sim_results_DEE_no_sm = parallel::mclapply(X = 1:10, mc.cores = use_cores,
#       FUN = function(x){MVN_CRP_sampler_DEE(
#         S = n_iter, seed = seeds[x], y = yreps[[x]]$y, 
#         alpha = 1, r = 10, g = 1, h = 50,
#         sigma_hyperprior = FALSE, fix_r = FALSE, 
#         mu0 = matrix(round((colMeans(matrix(unlist(yreps[[x]]$y), ncol = 2))),0), ncol = 1), 
#         a = 1, b = 50,
#         k_init = 1, diag_weights = FALSE, 
#         verbose = FALSE, split_merge = FALSE
#         )}
#       )
# 
# saveRDS(object = sim_results_DEE_no_sm, file = "../MCMC_Runs/conjDEEsamp_minisimstudy_noSM_6_Dec_2023.rds")
sim_results_DEE_no_sm = readRDS(file = "../MCMC_Runs/conjDEEsamp_minisimstudy_noSM_6_Dec_2023.rds")

for(rep in 1:nreps){
  print(table(sim_results_DEE_no_sm[[rep]]$k))
  p1 = make_k_traceplot(k = sim_results_DEE_no_sm[[rep]]$k, 
                        group_assign = sim_results_DEE_no_sm[[rep]]$group_assign)
  print(p1)
}
```


##### with split-merge step

```{r}
# sim_results_DEE_with_sm = parallel::mclapply(X = 1:10, mc.cores = use_cores,
#       FUN = function(x){MVN_CRP_sampler_DEE(
#         S = n_iter, seed = seeds[x], y = yreps[[x]]$y, 
#         alpha = 1, r = 10, g = 1, h = 50,
#         sigma_hyperprior = FALSE, fix_r = FALSE, 
#         mu0 = matrix(round((colMeans(matrix(unlist(yreps[[x]]$y), ncol = 2))),0), ncol = 1), 
#         a = 1, b = 50,
#         k_init = 1, diag_weights = FALSE, 
#         verbose = FALSE, split_merge = TRUE, sm_iter = 10
#         )}
#       )
# 
# saveRDS(object = sim_results_DEE_with_sm, file = "../MCMC_Runs/conjDEEsamp_minisimstudy_withSM_6_Dec_2023.rds")
sim_results_DEE_with_sm = readRDS(file = "../MCMC_Runs/conjDEEsamp_minisimstudy_withSM_6_Dec_2023.rds")

for(rep in 1:nreps){
  print(table(sim_results_DEE_with_sm[[rep]]$k))
  p1 = make_k_traceplot(k = sim_results_DEE_with_sm[[rep]]$k, 
                        group_assign = sim_results_DEE_with_sm[[rep]]$group_assign)
  print(p1)
}
```

#### UVV sampler 

##### without split-merge step

```{r}
sim_results_UVV_no_sm = parallel::mclapply(X = 1:10, mc.cores = use_cores,
      FUN = function(x){MVN_CRP_sampler_UVV(
        S = n_iter, seed = seeds[x], y = yreps[[x]]$y, 
        alpha = 1, r = 10, g = 1, h = 50, nu = 2,
        fix_r = FALSE, 
        mu0 = matrix(round((colMeans(matrix(unlist(yreps[[x]]$y), ncol = 2))),0), ncol = 1), 
        lambda0 = diag(x = 15, nrow = 2),
        k_init = 1, diag_weights = FALSE, 
        verbose = FALSE, split_merge = FALSE
        )}
      )

saveRDS(object = sim_results_UVV_no_sm, file = "../MCMC_Runs/conjUVVsamp_minisimstudy_noSM_6_Dec_2023.rds")

# for(rep in 1:nreps){
#   print(table(sim_results_DEE_with_sm[[rep]]$k))
#   p1 = make_k_traceplot(k = sim_results_DEE_with_sm[[rep]]$k, 
#                         group_assign = sim_results_DEE_with_sm[[rep]]$group_assign)
#   print(p1)
# }
```


##### with split-merge step

```{r}
# start_time = Sys.time()
# sim_results_UVV_with_sm = parallel::mclapply(X = 1:10, mc.cores = use_cores,
#       FUN = function(x){MVN_CRP_sampler_UVV(
#         S = n_iter, seed = seeds[x], y = yreps[[x]]$y,
#         alpha = 1, r = 10, g = 1, h = 50, nu = 2,
#         fix_r = FALSE,
#         mu0 = matrix(round((colMeans(matrix(unlist(yreps[[x]]$y), ncol = 2))),0), ncol = 1),
#         lambda0 = diag(x = 15, nrow = 2),
#         k_init = 1, diag_weights = FALSE,
#         verbose = FALSE, split_merge = TRUE, sm_iter = 10
#         )}
#       )
# end_time = Sys.time()
# run_time = difftime(end_time, start_time)
# print(run_time)

sim_results_UVV_with_sm = list()

for(x in 1:nreps){
        cat("Starting rep:", rep)
        cat("\n")
        rep_result = MVN_CRP_sampler_UVV(
        S = n_iter, seed = seeds[x], y = yreps[[x]]$y,
        alpha = 1, r = 10, g = 1, h = 50, nu = 2,
        fix_r = FALSE,
        mu0 = matrix(round((colMeans(matrix(unlist(yreps[[x]]$y), ncol = 2))),0), ncol = 1),
        lambda0 = diag(x = 15, nrow = 2),
        k_init = 1, diag_weights = FALSE,
        verbose = FALSE, split_merge = TRUE, sm_iter = 5)

        sim_results_UVV_with_sm[[x]] = rep_result
  }
      

# saveRDS(object = sim_results_UVV_with_sm, file = "../MCMC_Runs/conjUVVsamp_minisimstudy_withSM_3_Jan_2024.rds")
```


## 2D Example - close together

Mixture of 3 multivariate normal densities all with diagonal variance structure
and $\sigma^2 = 10$. The true means are $(10,10)$, $(0,-5)$, , $(12,-2)$, and $(0,10)$, and
$\sum_{j}n_j = 50$.

```{r, echo=FALSE}
################## simulate data ##############################################
w = c(.35, .25, .4)
means = list(
  #c(10, 10),
  c(0, -5),
  c(0, 10),
  c(12,2)
)

var = diag(9, length(means[[1]])) # variances known, diagonal, and equal

yreps = lapply(X = 1:nreps, 
           FUN = function(x){
             set.seed(seeds[x])
             assign = sample(x = 1:length(means), size = 30, replace = TRUE, prob = w)
             y = lapply(X = assign,
                        FUN = function(x){
                        t(mvtnorm::rmvnorm(n = 1, mean = means[[x]], sigma = var))
                          })
             return(list(y = y, assign = assign))
           })

# make a grid of plots
pltlist = list()
for(rep in 1:nreps){

  y_matrix = matrix(data = unlist(yreps[[rep]]$y), ncol = 2, byrow = TRUE)
  assign = yreps[[rep]]$assign

  data = data.frame(
    assign = assign,
    y1 = y_matrix[,1],
    y2 = y_matrix[,2]
  )

  p = ggplot(data = data, aes(x = y1, y = y2)) + #, label = rownames(data))) +
    geom_point(color = assign, size = 0.75) +
    #geom_text(size = 3, hjust = 0, nudge_x = 0.5, color = assign) +
    # geom_text(size = 3, color = assign) +
    theme_classic()

  pltlist[[rep]] = p
}

do.call(grid.arrange, pltlist)#, top = "Simulated 2D Data and True Group Assignments")

# drop params used to generate data, except for var which is assumed known
rm(w, means)
```


#### DEV sampler 

##### without split-merge step

```{r}
# n_iter = 5000
# use_cores = min(parallel::detectCores(), nreps)
# sim_results_DEV_no_sm = parallel::mclapply(X = 1:10, mc.cores = use_cores,
#       FUN = function(x){MVN_CRP_sampler_DEV(
#         S = n_iter, seed = seeds[x], y = yreps[[x]]$y, 
#         alpha = 1, r = 10, g = 1, h = 50,
#         sigma_hyperprior = FALSE, fix_r = FALSE, 
#         mu0 = matrix(round((colMeans(matrix(unlist(yreps[[x]]$y), ncol = 2))),0), ncol = 1), 
#         a = 1, b = 50,
#         k_init = 1, diag_weights = FALSE, 
#         verbose = FALSE, split_merge = FALSE
#         )}
#       )
# 
# saveRDS(object = sim_results_DEV_no_sm, file = "../MCMC_Runs/conjDEVsamp_minisimstudy_close_noSM_6_Dec_2023.rds")

sim_results_DEV_no_sm = readRDS(file = "../MCMC_Runs/conjDEVsamp_minisimstudy_close_noSM_6_Dec_2023.rds")

for(rep in 1:nreps){
  print(table(sim_results_DEV_no_sm[[rep]]$k))
  p1 = make_k_traceplot(k = sim_results_DEV_no_sm[[rep]]$k, 
                        group_assign = sim_results_DEV_no_sm[[rep]]$group_assign)
  print(p1)
}
```


##### with split-merge step

```{r}
# sim_results_DEV_with_sm = parallel::mclapply(X = 1:10, mc.cores = use_cores,
#       FUN = function(x){MVN_CRP_sampler_DEV(
#         S = n_iter, seed = seeds[x], y = yreps[[x]]$y, 
#         alpha = 1, r = 10, g = 1, h = 50,
#         sigma_hyperprior = FALSE, fix_r = FALSE, 
#         mu0 = matrix(round((colMeans(matrix(unlist(yreps[[x]]$y), ncol = 2))),0), ncol = 1), 
#         a = 1, b = 50,
#         k_init = 1, diag_weights = FALSE, 
#         verbose = FALSE, split_merge = TRUE, sm_iter = 10
#         )}
#       )
# 
# saveRDS(object = sim_results_DEV_with_sm, 
#         file = "../MCMC_Runs/conjDEVsamp_minisimstudy_close_withSM_6_Dec_2023.rds")

sim_results_DEV_with_sm = readRDS(file = "../MCMC_Runs/conjDEVsamp_minisimstudy_close_withSM_6_Dec_2023.rds")

for(rep in 1:nreps){
  print(table(sim_results_DEV_with_sm[[rep]]$k))
  p1 = make_k_traceplot(k = sim_results_DEV_with_sm[[rep]]$k, 
                        group_assign = sim_results_DEV_with_sm[[rep]]$group_assign)
  print(p1)
}
```

#### DEE sampler 

##### without split-merge step

```{r}
# sim_results_DEE_no_sm = parallel::mclapply(X = 1:10, mc.cores = use_cores,
#       FUN = function(x){MVN_CRP_sampler_DEE(
#         S = n_iter, seed = seeds[x], y = yreps[[x]]$y, 
#         alpha = 1, r = 10, g = 1, h = 50,
#         sigma_hyperprior = FALSE, fix_r = FALSE, 
#         mu0 = matrix(round((colMeans(matrix(unlist(yreps[[x]]$y), ncol = 2))),0), ncol = 1), 
#         a = 1, b = 50,
#         k_init = 1, diag_weights = FALSE, 
#         verbose = FALSE, split_merge = FALSE
#         )}
#       )
# 
# saveRDS(object = sim_results_DEE_no_sm, file = "../MCMC_Runs/conjDEEsamp_minisimstudy_close_noSM_6_Dec_2023.rds")

sim_results_DEE_no_sm = readRDS(file = "../MCMC_Runs/conjDEEsamp_minisimstudy_close_noSM_6_Dec_2023.rds")

for(rep in 1:nreps){
  print(table(sim_results_DEE_no_sm[[rep]]$k))
  p1 = make_k_traceplot(k = sim_results_DEE_no_sm[[rep]]$k, 
                        group_assign = sim_results_DEE_no_sm[[rep]]$group_assign)
  print(p1)
}
```


##### with split-merge step

```{r, eval=FALSE}
# sim_results_DEE_with_sm = parallel::mclapply(X = 1:10, mc.cores = use_cores,
#       FUN = function(x){MVN_CRP_sampler_DEE(
#         S = n_iter, seed = seeds[x], y = yreps[[x]]$y, 
#         alpha = 1, r = 10, g = 1, h = 50,
#         sigma_hyperprior = FALSE, fix_r = FALSE, 
#         mu0 = matrix(round((colMeans(matrix(unlist(yreps[[x]]$y), ncol = 2))),0), ncol = 1), 
#         a = 1, b = 50,
#         k_init = 1, diag_weights = FALSE, 
#         verbose = FALSE, split_merge = TRUE, sm_iter = 10
#         )}
#       )
# 
# saveRDS(object = sim_results_DEE_with_sm, file = "../MCMC_Runs/conjDEEsamp_minisimstudy_close_withSM_6_Dec_2023.rds")

sim_results_DEE_with_sm = readRDS(file = "../MCMC_Runs/conjDEEsamp_minisimstudy_close_withSM_6_Dec_2023.rds")

for(rep in 1:nreps){
  print(table(sim_results_DEE_with_sm[[rep]]$k))
  p1 = make_k_traceplot(k = sim_results_DEE_with_sm[[rep]]$k, 
                        group_assign = sim_results_DEE_with_sm[[rep]]$group_assign)
  print(p1)
}
```
Some iterations failed. 


#### UVV sampler 

##### without split-merge step

```{r}
sim_results_UVV_no_sm = parallel::mclapply(X = 1:10, mc.cores = use_cores,
      FUN = function(x){MVN_CRP_sampler_UVV(
        S = n_iter, seed = seeds[x], y = yreps[[x]]$y,
        alpha = 1, r = 10, g = 1, h = 50, nu = 2,
        fix_r = FALSE,
        mu0 = matrix(round((colMeans(matrix(unlist(yreps[[x]]$y), ncol = 2))),0), ncol = 1),
        lambda0 = diag(x = 15, nrow = 2),
        k_init = 1, diag_weights = FALSE,
        verbose = FALSE, split_merge = FALSE
        )}
      )

saveRDS(object = sim_results_UVV_no_sm, file = "../MCMC_Runs/conjUVVsamp_minisimstudy_close_noSM_6_Dec_2023.rds")

# sim_results_UVV_no_sm = readRDS(file = "../MCMC_Runs/conjUVVsamp_minisimstudy_close_noSM_6_Dec_2023.rds")

# for(rep in 1:nreps){
#   print(table(sim_results_UVV_no_sm[[rep]]$k))
#   p1 = make_k_traceplot(k = sim_results_UVV_no_sm[[rep]]$k, 
#                         group_assign = sim_results_UVV_no_sm[[rep]]$group_assign)
#   print(p1)
# }
```


##### with split-merge step

```{r}
sim_results_UVV_with_sm = parallel::mclapply(X = 1:10, mc.cores = use_cores,
      FUN = function(x){MVN_CRP_sampler_UVV(
        S = n_iter, seed = seeds[x], y = yreps[[x]]$y,
        alpha = 1, r = 10, g = 1, h = 50, nu = 2,
        fix_r = FALSE,
        mu0 = matrix(round((colMeans(matrix(unlist(yreps[[x]]$y), ncol = 2))),0), ncol = 1),
        lambda0 = diag(x = 15, nrow = 2),
        k_init = 1, diag_weights = FALSE,
        verbose = FALSE, split_merge = TRUE, sm_iter = 5
        )}
      )

saveRDS(object = sim_results_UVV_with_sm, file = "../MCMC_Runs/conjUVVsamp_minisimstudy_close_withSM_6_Dec_2023.rds")

```
This took too long...over 1.5 hours. Had to kill job for time. Need to reexamine
and determine how to handle in future. 
