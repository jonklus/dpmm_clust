---
title: "Conjugate Sampler - Unknown Variance"
author: "Jonathan Klus"
date: "2023-10-03"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# load necessary functions
source("./Multivariate_DPMM_unknownvar_conjugate.R")
source("./posterior_helper_fxns.R")

# load R libraries
library(ggplot2)
library(plotly)
library(label.switching)
library(LaplacesDemon)
library(coda)
library(tidyr)
```

## EII Sampler Setup

- $y_1, \dots, y_n \sim \sum_{k=1}^K\pi_kN(\mu_k, \sigma^2 I_J)$
- $\mu_1, \dots, \mu_K \sim N(\mu_0, r\sigma^2 I_J)$
- $\sigma^2 \sim IG(a,b)$
- $r \sim IG(g, h)$
- $b \sim Ga(d, f)$

## VII Sampler Setup

- $y_1, \dots, y_n \sim \sum_{k=1}^K\pi_kN(\mu_k, \sigma^2_k I_J)$
- $\mu_1, \dots, \mu_K \sim N(\mu_0, r\sigma^2_k I_J)$
- $\sigma^2_1,\dots, \sigma^2_K \sim IG(a,b)$
- $r \sim IG(g, h)$
- $b \sim Ga(d, f)$

## EVV Sampler Setup

- $y_1, \dots, y_n \sim \sum_{k=1}^K\pi_kN(\mu_k, \Sigma_k)$
- $\mu_1, \dots, \mu_K \sim N(\mu_0, r\Sigma_k)$
- $\Sigma_1,\dots, \Sigma_K \sim invWish(\nu,(\nu\Lambda_0)^{-1})$
- $r \sim IG(g, h)$

## Sampler Examples

### 2D Example - well separated

Mixture of 3 multivariate normal densities all with diagonal variance structure
and $\sigma^2 = 10$. The true means are $(-20,20)$, $(20,-20)$, and $(0,0)$, and
$\sum_{j}n_j = 30$.

```{r, echo=FALSE}
################## simulate data ##############################################
w = c(0.4, 0.3, 0.3)
means = list(
  c(-20, 20),
  c(20, -20),
  c(0, 0)
)

var = diag(10, length(means[[1]])) # variances known, diagonal, and equal

assign = sample(x = 1:length(means), size = 30, replace = TRUE, prob = w)
y = lapply(X = assign,
           FUN = function(x){
             t(mvtnorm::rmvnorm(n = 1, mean = means[[x]], sigma = var))
           })
y_matrix = matrix(data = unlist(y), ncol = 2, byrow = TRUE)

data = data.frame(
  assign = assign,
  y1 = y_matrix[,1],
  y2 = y_matrix[,2]
)

ggplot(data = data, aes(x = y1, y = y2, label = rownames(data))) +
  #geom_point(color = assign) +
  #geom_text(size = 3, hjust = 0, nudge_x = 0.5, color = assign) +
  geom_text(size = 3, color = assign) +
  ggtitle("Simulated 2D Data and True Group Assignments") + 
  theme_classic()

# drop params used to generate data, except for var which is assumed known
rm(w, means)
```

#### EVV sampler 

```{r}
# sample
set.seed(516)
n_iter = 10^4
start_run = Sys.time()
mu0 = matrix(round((colMeans(matrix(unlist(y), ncol = 2))),0), ncol = 1)
print(mu0)
ex1 = MVN_CRP_sampler_EVV(S = n_iter, y = y, alpha = 1, r = 10, 
                          g = 1, h = 50, 
                          nu_hyperprior = FALSE, fix_r = FALSE, 
                          mu0 = mu0, nu = 2,
                          lambda0 = diag(x = 10, nrow = 2),
                          k_init = 1, diag_weights = FALSE, 
                          verbose = TRUE, print_iter = 10^3, 
                          split_merge = TRUE, sm_iter = 5)
end_run = Sys.time()
difftime(time1 = end_run, time2 = start_run)

saveRDS(object = ex1, file = "../MCMC_Runs/conjEVVsamp_wellsep_nu2_g1_h50_rvaries_withSM.rds")

table(ex1$k)

sm_result_ex1 = data.frame(ex1$sm_results) %>%
  dplyr::filter(is.na(s) == FALSE) %>%
  dplyr::mutate(
    move_type = factor(move_type),
    s = as.integer(s),
    sm_iter = as.integer(sm_iter),
    accept = as.integer(accept),
    prob = as.numeric(prob)
  ) %>%
  dplyr::group_by(move_type) %>%
  dplyr::summarise(prob_Accept = mean(accept))

# traceplot for number of components k.

make_k_traceplot(k = ex1$k, group_assign = ex1$group_assign)
summary(ex1$extra_params[1:n_iter,"r"])

# fix label switching

# posterior inference conditional on k 

mean_list_by_k1 = list_params_by_k(draws = ex1$means, burn_in = 1000, param_type = "Mean", k_vec = ex1$k)
var_list_by_k1 = list_params_by_k(draws = ex1$vars, burn_in = 1000, param_type = "Var", k_vec = ex1$k)
#sigma22 is group 2, 2nd diagonal element
prob_list_by_k1 = get_probs_by_k(probs = ex1$group_probs,
                                n_groups = ex1$k,
                                burn_in = 1000)
group_assign_list_by_k1 = get_assign_by_k(assign = ex1$group_assign,
                                         n_groups = ex1$k,
                                         burn_in = 1000)

stephens_result1 = get_stephens_result(group_assign_list_by_k = group_assign_list_by_k1,
                                       prob_list_by_k = prob_list_by_k1)

## now reorder means to deal with label switching and redo posterior inference and
## traceplots
mean_list_by_k_stephens1 = list_params_by_k(draws = ex1$means, k_vec = ex1$k,
                                           burn_in = 1000,
                                           relabel = TRUE,
                                           permutation = stephens_result1,
                                           param_type = "Mean")
var_list_by_k_stephens1 = list_params_by_k(draws = ex1$vars, k_vec = ex1$k,
                                           burn_in = 1000,
                                           relabel = TRUE,
                                           permutation = stephens_result1,
                                           param_type = "Var")

# posterior means
make_postsum(mcmc_df = mean_list_by_k_stephens1[[1]], digits = 2)
make_postsum(mcmc_df = mean_list_by_k_stephens1[[2]], digits = 2)
make_postsum(mcmc_df = mean_list_by_k_stephens1[[3]], digits = 2)

# posterior vars
make_postsum(mcmc_df = var_list_by_k_stephens1[[1]], digits = 2)
make_postsum(mcmc_df = var_list_by_k_stephens1[[2]], digits = 2)
make_postsum(mcmc_df = var_list_by_k_stephens1[[3]], digits = 2)

make_traceplot(param_list_by_k = mean_list_by_k_stephens1,
               k = 3, p = 2,
               component_no = 1,
               param_type = "Mean")

make_traceplot(param_list_by_k = mean_list_by_k_stephens1,
               k = 3, p = 2,
               component_no = 2,
               param_type = "Mean")
```

## 2D Example - close together

Mixture of 3 multivariate normal densities all with diagonal variance structure
and $\sigma^2 = 10$. The true means are $(10,10)$, $(0,-5)$, , $(12,-2)$, and $(0,10)$, and
$\sum_{j}n_j = 50$.

```{r, echo=FALSE}
################## simulate data ##############################################
set.seed(1234)
w = c(.35, .25, .4)
means = list(
  #c(10, 10),
  c(0, -5),
  c(0, 10),
  c(12,2)
)

var = diag(9, length(means[[1]])) # variances known, diagonal, and equal

assign = sample(x = 1:length(means), size = 50, replace = TRUE, prob = w)
y = lapply(X = assign,
           FUN = function(x){
             t(mvtnorm::rmvnorm(n = 1, mean = means[[x]], sigma = var))
           })
y_matrix = matrix(data = unlist(y), ncol = 2, byrow = TRUE)

data = data.frame(
  assign = assign,
  y1 = y_matrix[,1],
  y2 = y_matrix[,2]
)

# empirical means and variances
data %>%
  group_by(assign) %>%
  dplyr::summarize(mean(y1), mean(y2), var(y1), var(y2))

ggplot(data = data, aes(x = y1, y = y2)) +
  geom_point(color = assign) +
  ggtitle("Simulated 2D Data and True Group Assignments") + 
  theme_classic()

# drop params used to generate data, except for var which is assumed known
rm(w, means)
```

#### EVV sampler 

```{r}
# sample
set.seed(516)
n_iter = 10^4
mu0 = matrix(round((colMeans(matrix(unlist(y), ncol = 2))),0), ncol = 1)
print(mu0)
ex1 = MVN_CRP_sampler_EVV(S = n_iter, y = y, alpha = 1, r = 10, 
                          g = 1, h = 50, 
                          nu_hyperprior = FALSE, fix_r = FALSE, 
                          mu0 = mu0, nu = 2,
                          lambda0 = diag(x = 10, nrow = 2),
                          k_init = 1, diag_weights = FALSE, 
                          verbose = TRUE, print_iter = 10^3)
saveRDS(object = ex1, file = "./MCMC_Runs/conjEVVsamp_lesswellsep_nu2_g1_h50_rvaries.rds")

table(ex1$k)

# traceplot for number of components k.

make_k_traceplot(k = ex1$k, group_assign = ex1$group_assign)
summary(ex1$extra_params[1:n_iter,"r"])

# fix label switching

# posterior inference conditional on k 

mean_list_by_k1 = list_params_by_k(draws = ex1$means, burn_in = 1000, param_type = "Mean", k_vec = ex1$k)
var_list_by_k1 = list_params_by_k(draws = ex1$vars, burn_in = 1000, param_type = "Var", k_vec = ex1$k)
#sigma22 is group 2, 2nd diagonal element
prob_list_by_k1 = get_probs_by_k(probs = ex1$group_probs,
                                n_groups = ex1$k,
                                burn_in = 1000)
group_assign_list_by_k1 = get_assign_by_k(assign = ex1$group_assign,
                                         n_groups = ex1$k,
                                         burn_in = 1000)

stephens_result1 = get_stephens_result(group_assign_list_by_k = group_assign_list_by_k1,
                                       prob_list_by_k = prob_list_by_k1)

## now reorder means to deal with label switching and redo posterior inference and
## traceplots
mean_list_by_k_stephens1 = list_params_by_k(draws = ex1$means, k_vec = ex1$k,
                                           burn_in = 1000,
                                           relabel = TRUE,
                                           permutation = stephens_result1,
                                           param_type = "Mean")
var_list_by_k_stephens1 = list_params_by_k(draws = ex1$vars, k_vec = ex1$k,
                                           burn_in = 1000,
                                           relabel = TRUE,
                                           permutation = stephens_result1,
                                           param_type = "Var")

# posterior means
make_postsum(mcmc_df = mean_list_by_k_stephens1[[1]], digits = 2)
make_postsum(mcmc_df = mean_list_by_k_stephens1[[2]], digits = 2)
make_postsum(mcmc_df = mean_list_by_k_stephens1[[3]], digits = 2)

# posterior vars
make_postsum(mcmc_df = var_list_by_k_stephens1[[1]], digits = 2)
make_postsum(mcmc_df = var_list_by_k_stephens1[[2]], digits = 2)
make_postsum(mcmc_df = var_list_by_k_stephens1[[3]], digits = 2)

make_traceplot(param_list_by_k = mean_list_by_k_stephens1,
               k = 3, p = 2,
               component_no = 1,
               param_type = "Mean")

make_traceplot(param_list_by_k = mean_list_by_k_stephens1,
               k = 3, p = 2,
               component_no = 2,
               param_type = "Mean")

make_traceplot(param_list_by_k = mean_list_by_k_stephens1,
               k = 4, p = 2,
               component_no = 1,
               param_type = "Mean")

make_traceplot(param_list_by_k = mean_list_by_k_stephens1,
               k = 4, p = 2,
               component_no = 2,
               param_type = "Mean")
```